<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | BROcoli</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="BROcoli">
    
    <!-- iOS Safari specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BROcoli">
    <meta name="format-detection" content="telephone=no">
    
    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152x152.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-96x96.png">
    
    <!-- PWA Install Wizard Styles -->
    <link rel="stylesheet" href="pwa-install.css">
    
    <style>
      /* Full-screen dark background to fill areas outside 16:9 aspect ratio */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000000;
        /* iOS Safari safe area support */
        padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      #unity-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* Prevent touch callouts and text selection on iOS */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        /* Ensure touch events work properly */
        touch-action: none;
      }
      
      /* iOS Safari fullscreen fix */
      @supports (-webkit-touch-callout: none) {
        body {
          /* Use viewport units that account for iOS Safari's dynamic toolbar */
          min-height: -webkit-fill-available;
        }
        #unity-canvas {
          height: -webkit-fill-available;
        }
      }
      
      /* PWA Standalone mode - truly fullscreen */
      @media all and (display-mode: standalone), all and (display-mode: fullscreen) {
        html, body {
          /* Remove any padding that might interfere */
          padding: 0 !important;
        }
        #unity-canvas {
          /* Ensure full coverage in standalone mode */
          width: 100vw !important;
          height: 100vh !important;
          height: 100dvh !important; /* Dynamic viewport height */
        }
      }
      
      /* Loading screen */
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.5s ease;
      }
      
      #loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(79, 172, 254, 0.2);
        border-top-color: #4facfe;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .loading-text {
        color: #a0a0a0;
        margin-top: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
      }
      
      .loading-progress {
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin-top: 15px;
        overflow: hidden;
      }
      
      .loading-progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        border-radius: 2px;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body style="text-align: center; padding: 0; border: 0; margin: 0; background-color: #000000;">
    <!-- Loading Screen -->
    <div id="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading game...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loading-progress-bar"></div>
      </div>
    </div>
    
    <canvas id="unity-canvas" style="width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: #000000;"></canvas>
    
    <!-- PWA Install Wizard Script -->
    <script src="pwa-install.js"></script>
    
    <script src="Build/WebGL.loader.js"></script>
    <script>
      // Detect iOS Safari for special handling
      var isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      var isMacWithTouch = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      var isiOSDevice = isiOS || isMacWithTouch;
      var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || isiOSDevice;
      var isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                         window.matchMedia('(display-mode: fullscreen)').matches ||
                         window.navigator.standalone === true;
      
      console.log('[WebGL] Platform detection - iOS: ' + isiOS + ', MacTouch: ' + isMacWithTouch + ', Safari: ' + isSafari + ', Mobile: ' + isMobile + ', Standalone: ' + isStandalone);
      
      // Setup viewport meta tag for proper mobile rendering
      var meta = document.createElement('meta');
      meta.name = 'viewport';
      // iOS Safari needs specific viewport settings
      if (isiOSDevice) {
        meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
      } else {
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
      }
      document.getElementsByTagName('head')[0].appendChild(meta);

      var canvas = document.querySelector("#unity-canvas");
      var loadingScreen = document.getElementById('loading-screen');
      var progressBar = document.getElementById('loading-progress-bar');
      
      // Function to update canvas resolution to match window size
      function updateCanvasSize() {
        var dpr = window.devicePixelRatio || 1;
        var width = window.innerWidth;
        var height = window.innerHeight;
        
        // In standalone mode, use full viewport
        if (isStandalone) {
          // Use visualViewport if available for more accurate sizing
          if (window.visualViewport) {
            width = window.visualViewport.width;
            height = window.visualViewport.height;
          }
        }
        
        // Set the canvas drawing buffer size (actual resolution Unity renders at)
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        
        // Set CSS size to fill screen
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        
        console.log('[WebGL] Canvas updated - CSS: ' + width + 'x' + height + ', Buffer: ' + canvas.width + 'x' + canvas.height + ', DPR: ' + dpr);
      }
      
      // Full-screen canvas setup
      canvas.style.position = "fixed";
      canvas.style.top = "0";
      canvas.style.left = "0";
      canvas.style.touchAction = "none"; // Prevent browser touch gestures
      canvas.style.webkitTouchCallout = "none"; // Prevent iOS callouts
      canvas.style.webkitUserSelect = "none"; // Prevent text selection
      
      document.body.style.textAlign = "left";
      document.body.style.backgroundColor = "#000000";
      document.documentElement.style.backgroundColor = "#000000";
      
      // Initial size update
      updateCanvasSize();
      
      // Handle resize events for all platforms
      window.addEventListener('resize', function() {
        updateCanvasSize();
      });
      
      // Handle visual viewport changes (for virtual keyboards, etc.)
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', function() {
          updateCanvasSize();
        });
      }
      
      // iOS Safari specific touch handling
      if (isiOSDevice) {
        console.log('[WebGL] Applying iOS Safari touch fixes');
        
        // Prevent default touch behaviors that interfere with game input
        document.addEventListener('touchstart', function(e) {
          if (e.target === canvas) {
            e.preventDefault();
          }
        }, { passive: false });
        
        document.addEventListener('touchmove', function(e) {
          if (e.target === canvas) {
            e.preventDefault();
          }
        }, { passive: false });
        
        // Prevent iOS Safari's bounce/elastic scrolling
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.style.height = '100%';
        
        // Handle iOS Safari orientation changes (needs delay to let iOS settle)
        window.addEventListener('orientationchange', function() {
          setTimeout(updateCanvasSize, 100);
        });
      }
      
      // Try to auto-enter fullscreen on user interaction (for non-PWA mobile)
      if (isMobile && !isStandalone) {
        var hasRequestedFullscreen = false;
        
        function tryFullscreen() {
          if (hasRequestedFullscreen) return;
          hasRequestedFullscreen = true;
          
          var elem = document.documentElement;
          if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(function() {});
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
          }
        }
        
        // Request fullscreen on first touch (if not in PWA mode)
        canvas.addEventListener('touchstart', function() {
          // Small delay to ensure PWA prompt has been handled
          setTimeout(tryFullscreen, 100);
        }, { once: true });
      }

      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('sw.js')
            .then(function(registration) {
              console.log('[PWA] ServiceWorker registered:', registration.scope);
            })
            .catch(function(error) {
              console.warn('[PWA] ServiceWorker registration failed:', error);
            });
        });
      }

      createUnityInstance(document.querySelector("#unity-canvas"), {
        dataUrl: "Build/WebGL.data",
        frameworkUrl: "Build/WebGL.framework.js",
        codeUrl: "Build/WebGL.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "BudgetGameDev",
        productName: "BROcoli",
        productVersion: "0.0.95",
        matchWebGLToCanvasSize: true, // Enable dynamic resolution to match canvas size
        devicePixelRatio: window.devicePixelRatio || 1, // Use device pixel ratio for sharp rendering
        // Progress callback
        onProgress: function(progress) {
          if (progressBar) {
            progressBar.style.width = (progress * 100) + '%';
          }
        }
      }).then(function(unityInstance) {
        console.log('[WebGL] Unity instance created successfully');
        // Store reference for potential future use
        window.unityInstance = unityInstance;
        
        // Hide loading screen
        if (loadingScreen) {
          loadingScreen.classList.add('hidden');
          setTimeout(function() {
            loadingScreen.style.display = 'none';
          }, 500);
        }
        
        // Update canvas size again after Unity loads to ensure correct resolution
        updateCanvasSize();
      }).catch(function(error) {
        console.error('[WebGL] Unity instance creation failed:', error);
        if (loadingScreen) {
          loadingScreen.innerHTML = '<div style="color: #ff6b6b; font-family: sans-serif; text-align: center; padding: 20px;"><h2>Failed to load game</h2><p>' + error.message + '</p><button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px; cursor: pointer;">Retry</button></div>';
        }
      });
    </script>
  </body>
</html>
